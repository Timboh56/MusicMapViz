<!DOCTYPE html>
<html>
	<head>
		<title> Music Map Info Viz </title>
	    <link rel="stylesheet" href="jquery-jvectormap.css" type="text/css" media="screen"/>
	    <link rel="stylesheet" href="style.css" type="text/css" />
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="http://jvectormap.com/js/jquery-jvectormap-1.1.1.min.js"></script>
		<script type="text/javascript" src="http://jvectormap.com/js/jquery-jvectormap-world-mill-en.js"></script>
		<script type="text/javascript" src="http://jvectormap.com/js/jquery-jvectormap-us-aea-en.js"></script>	
		<script type="text/javascript" src="music.js"></script>			
		<script type="text/javascript">
		
		  	var artists = {};
		  	var tracks = {};
			var selected = true;
			var selected_type = "artists";
			var artist_selected = "Muse";
			var track_selected = "Gangnam Style";
			var worldmap;
		
			function select(selected_regions) {
				for (var i in selected_regions) {
					var country_name = window.worldmap.getRegionName(selected_regions[i]);
										
					// don't have listener info for country
					var listeners;
					if ( (listeners = findListeners(artist_selected,country_name,selected_type)) == -1) {
						if (selected_type = "artists") {
							getTopArtists(country_name,false);

						} else {
							getTopTracks(country_name,false);
						}
					
					 if (listeners == 0) {
						// do nothing about it
						alert("The country you selected does not have information about the artist or track you selected.");
						
						}
					}	
				}
			}
			
			function findListeners(artist,country_name,selected_type) {
				
				// check "cache" if there exists an top artist or track list for country
				if (selected_type = "artists") {
					if (artists[String(country_name)] != null) {
						if (artists[String(country_name)][String(artist_selected)] != null) {
							return artists[String(country_name)][String(artist_selected)]["listeners"];
						} else {
							// the artist was not in the top 50 list so no information can be gathered
							return 0;	
						}
					}
					
				} else {
					if (tracks[String(country_name)] != null) {
						if (tracks[String(country_name)][String(track_selected)] != null) {
							return tracks[String(country_name)][String(track_selected)]["listeners"];
						} else {
							
							// the track was not in the top 50 list so no information can be gathered
							return 0;	
						}
					}
				}
				
				// artist is not cached.
				return -1;
			
			}
			
			function artistorTrackSelected(){
				return selected;	
			}
			
			// show the list and save it to cache
			function showForCountry(items,list_type, country) {	
				if (artistorTrackSelected() == false) { 					
					$("#top_listlist").empty();
					$("#top_listlist").append("<h2>Top " + list_type + " for " + country + "</h2>");
					$("#top_listlist").append("<ul>");
					var count = 0;
					for ( var i in items ) {
						count++;
						if ( count > 10){
							// place holder: create some "Show more results" button
						} else{ 
							$("#top_listlist").append(items[i]["html"] + " <a href='#' onclick=''>Select </a>");
						}
					}
					$("#top_listlist").append("</ul>");
					saveList(items,list_type,country);
				}	
			}
			
			// save the list to cache
			function saveList(items, list_type, country) {	
							
				// store items for use 
				if (list_type == "artists") {
					artists[String(country)] = items;					
				} else {
					tracks[String(country)] = items;
				}
				// colorize algorithm
				var total_listeners = 0;
				for (var i in listener_count) {
					//listenercount
				}

			}
			
			function resetMap() {				
				selected = !selected;
				$("#map").vectorMap('get','mapObject').clearSelectedRegions();				
				$("#map").vectorMap('get','mapObject').remove();
				generateMap();
			}
			
			function getArtistSelected() {
				return artist_selected;
			}

			function getTopArtists(country_name,show) {
				if (selected_type != "artist");
				{
					changeType();
				}
			}
			
			function getTopTracks(country_name,show){
				if (selected_type != "tracks");
				{
					changeType();
				}
				map.getTop(country_name,"tracks",show);
			}
			
			function changeType() {
				switch(selected_type)
				{
					case "artists":
						selected_type = "tracks";
						break;
					case "tracks":
						selected_type = "artists";
						break;
					default:
						break;
				}
				$("#type_button").html("Comparing " + selected_type);
			}
			
			if ($.browser.webkit) {
				$('body').addClass('webkit');
			}
			
			function generateMap(){
				$("#map").vectorMap({
					container: $("#map"),
					map: 'world_mill_en',
					regionStyle: {
					  // selected: {
					  	//fill: "#00F100"
						//}
					  },
	  				  regionsSelectable: artistorTrackSelected(),
					  
					  
					  onRegionSelected: function(event,code,is_selected,selected_regions) {
					
						select(selected_regions);
						// collect info about region
						// basically you want to compare an artist's popularity among all selected regions
						// depending on the regions selected, the color gradient will be relevant 
						// with the country with the highest ranking for the artist colored darkest
						},
					  onRegionClick: function(event,code){				
						var country_name = $("#map").vectorMap('get','mapObject').getRegionName(code);
						if (country_name == "United States of America"){
							country_name = "USA";
						}
						$("#top_list").empty();
		   				$("#top_list").append(" <a href=\"#\" > " + country_name + "</a> ");
									
						$("#top_list").append(" | <a href=\"#\" onclick=\"getTopArtists('" + country_name + "',true); \" > Show Top Artists </a>");
						$("#top_list").append(" | <a href=\"#\" onclick=\"getTopTracks('" + country_name + "',true);\" > Show Top Tracks </a>");
						map.getTopChart();
					
					  } 
				});
				window.worldmap = $("#map").vectorMap('get','mapObject');				
			}
			
		    $(function(){
				generateMap();
		    });
			
		</script>
	</head>
	<body>
		<form>
			<button id="type_button" type="button" onclick="changeType();">Comparing artists</button>
			<button id="selected_button" type="button" onclick="resetMap();"> Change Context  </button>
			
			</form>
			
		<div id="artist_chosen"> Artist chosen: </div>
		<div id="map" style="width: 600px; height: 800px;"></div>
		<div id="top_list"> <b> Top Lists </b> 
			</div>
		<div id="top_listlist"> 
			</div>
			<div id="topchart"> </div>
	</body>
	
</html>
