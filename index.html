<!DOCTYPE html>
<html>
	<head>
		<title> Music Map Info Viz </title>
	    <link rel="stylesheet" href="jquery-jvectormap.css" type="text/css" media="screen"/>
	    <link rel="stylesheet" href="style.css" type="text/css" />
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="http://jvectormap.com/js/jquery-jvectormap-1.1.1.min.js"></script>
		<script type="text/javascript" src="http://jvectormap.com/js/jquery-jvectormap-world-mill-en.js"></script>
		<script type="text/javascript" src="http://jvectormap.com/js/jquery-jvectormap-us-aea-en.js"></script>	
		<script type="text/javascript" src="music.js"></script>			
		<script type="text/javascript">

			var listener_count = {};
			var selected = true;
			var selected_type = "artists";
			var artist_selected = "Muse";
			var track_selected = "Gangnam Style";
			var worldmap;
			
			function artistorTrackSelected(){
				return selected;	
			}
			
			function selectTrack(track) {
				if (artistorTrackSelected() == false) {
					changeContext();
				}else {
					resetMap();
				} 
				selected_type = "tracks";
				track_selected = track;
				$("#chosen_item").append(" Track chosen: <h3>" + track_selected + "</h3>");					
			}
			
			function selectArtist(artist) {
				if (artistorTrackSelected() == false) {
					changeContext();
				}else {
					resetMap();
				} 
				selected_type = "artists";
				artist_selected = artist;
				$("#chosen_item").append(" Artist chosen: <h3>" + artist_selected + "</h3>");
			}
			
			// show the list and save it to cache
			function showForCountry(items,list_type, country) {	
				if (artistorTrackSelected() == false) { 					
					$("#top_listlist").empty();
					$("#top_listlist").append("<h2>Top " + list_type + " for " + country + "</h2>");
					$("#top_listlist").append("<ul>");
					var count = 0;
					for ( var i in items ) {
						count++;
						if ( count > 10){
							// place holder: create some "Show more results" button
						} else{ 
							$("#top_listlist").append(items[i]["html"] + " <a href='#' onclick=\"selectTrack('" + i + "');\">Select </a>");
						}
					}
					$("#top_listlist").append("</ul>");
				}	
			}
			
			function saveList(items, code) {	
				var listeners = 0;
				if (selected_type == "artists") {
					// artist selected is on the top 50 list you got from last fm					
					if (items[String(artist_selected)] != null ) {
						listeners = items[String(artist_selected)]["listeners"];
					}
				} else {
					if (items[String(track_selected)] != null ) {
						listeners = items[String(track_selected)]["listeners"];
					}
				}
				listener_count[code] = listeners;
				$("#top_list").empty();
				
				if (selected_type == "artists") {
					$("#top_list").append(artist_selected + " has " + listeners + " listeners in " + window.worldmap.getRegionName(code));
				} else {
					$("#top_list").append(track_selected + " has " + listeners + " listeners in " + window.worldmap.getRegionName(code));				
				
				}
				
				var sum = 0;
				for ( var v in listener_count ) {
					sum = sum + parseInt(listener_count[v]); 
				}
				
				for ( var i in listener_count ) {
					var div = 1 - parseInt(listener_count[i])/sum;
					var rgb = parseInt(div*255);
					var data = {};
					data[i] ="RGB(" + rgb + "," + rgb + ",255)";
					window.worldmap.series.regions[0].setValues(data);
				}					
			}
			
			function resetMap() {
				$("#chosen_item").empty();
				listener_count = {};
				$("#map").vectorMap('get','mapObject').clearSelectedRegions();				
				$("#map").vectorMap('get','mapObject').remove();
				generateMap();
			}
			
			function changeContext() {
				selected = !selected;
				resetMap();
			}
			
			function getArtistSelected() {
				return artist_selected;
			}

			function getTopArtists(code,country_name,show) {
				map.getTop(code,country_name,"artists",show);
			}
			
			function getTopTracks(code,country_name,show){
				map.getTop(code,country_name,"tracks",show);
			}
			
			function submitText() {
				resetMap();
				if (selected_type == "artists") {
					selectArtist($("#text_form").val());
				} else {
					selectTrack($("#text_form").val());
				}
			}
			
			function changeType() {
				switch(selected_type)
				{
					case "artists":
						selected_type = "tracks";
						break;
					case "tracks":
						selected_type = "artists";
						break;
					default:
						break;
				}
				$("#type_button").html("Comparing " + selected_type);
			}
			
			if ($.browser.webkit) {
				$('body').addClass('webkit');
			}
			
			function generateMap(){
			    window.worldmap = new jvm.WorldMap({
					container: $("#map"),
					map: 'world_mill_en',
				    series: {
				      regions: [{
				        attribute: 'fill'
				      }]
				    },
					onRegionClick: function(event,code){
						var country_name = $("#map").vectorMap('get','mapObject').getRegionName(code);
						if (country_name == "United States of America"){
							country_name = "USA";
						}
						if ( artistorTrackSelected() == false) {
							$("#top_list").empty();
			   				$("#top_list").append(" <a href=\"#\" > " + country_name + "</a> ");
									
							$("#top_list").append(" | <a href=\"#\" onclick=\"getTopArtists('" + code + "','" + country_name + "',true); \" > Show Top Artists </a>");
							$("#top_list").append(" | <a href=\"#\" onclick=\"getTopTracks('" + code + "','" + country_name + "',true);\" > Show Top Tracks </a>");
							map.getTopChart();
						} else {
							if (selected_type == "artists") {
								map.getTop(code,country_name,"artists",false);
							} else {
								map.getTop(code,country_name,"tracks",false);
							}
						}
					
					} 
				});
			}
			
		    $(function(){
				generateMap();
		    });
			
			
		</script>
	</head>
	<body>
		<form>
			<button id="type_button" type="button" onclick="changeType();">Comparing artists</button>
			<button id="selected_button" type="button" onclick="changeContext();"> Change Context  </button>
			<input type="text" id="text_form"></input>
			<button id="submit_text" type="button" onclick="submitText();"> Submit Artist or Track </button>
			</form>
			
		<div id="chosen_item"> </div>
		<div id="map" style="width: 600px; height: 800px;"></div>
		<div id="top_list"> 
			</div>
		<div id="top_listlist"> 
			</div>
			<div id="topchart"> </div>
	</body>
	
</html>
